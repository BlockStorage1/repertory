#!groovy

pipeline {
  agent any

  environment {
    REPERTORY_TEST_DIR = "C:\\.ci\\cfg"
  }

  options {
    disableConcurrentBuilds()
    retry(2)
  }

  stages {
    stage('clean') {
      steps {
        bat 'del /q build\\Release\\librepertory.lib || exit 0'
        bat 'del /q build\\Release\\unittests.exe || exit 0'
        bat 'del /q build\\Release\\repertory.exe || exit 0'
      }
    }

    stage('configure') {
      steps {
        cmake arguments: '.. -DCMAKE_BUILD_TYPE=Release -DREPERTORY_ENABLE_S3=ON', installation: 'InSearchPath', workingDir: 'build'
      }
    }

    stage('build') {
      steps {
        retry(2) {
          sleep time: 5, unit: 'SECONDS'
          cmake arguments: '--build . --target ALL_BUILD --config Release -j 4', installation: 'InSearchPath', workingDir: 'build'
        }
      }
    }
  }
}
